import{_ as n,C as l,c as p,o as d,j as t,aA as o,a as e,G as a}from"./chunks/framework.C07RQYAL.js";const M=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"pages/code/optimization.md","filePath":"pages/code/optimization.md","lastUpdated":null}'),r={name:"pages/code/optimization.md"},c={class:"jldocstring custom-block",open:""},h={class:"jldocstring custom-block",open:""},u={class:"jldocstring custom-block",open:""},m={class:"jldocstring custom-block",open:""},g={class:"jldocstring custom-block",open:""},k={class:"jldocstring custom-block",open:""},b={class:"jldocstring custom-block",open:""},f={class:"jldocstring custom-block",open:""},y={class:"jldocstring custom-block",open:""},_={class:"jldocstring custom-block",open:""},E={class:"jldocstring custom-block",open:""},v={class:"jldocstring custom-block",open:""},C={class:"jldocstring custom-block",open:""};function z(A,i,S,T,F,O){const s=l("Badge");return d(),p("div",null,[t("details",c,[t("summary",null,[i[0]||(i[0]=t("a",{id:"SindbadOptimization",href:"#SindbadOptimization"},[t("span",{class:"jlbinding"},"SindbadOptimization")],-1)),i[1]||(i[1]=e()),a(s,{type:"info",class:"jlObjectType jlModule",text:"Module"})]),i[2]||(i[2]=o(`<div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SindbadOptimization</span></span></code></pre></div><p>The <code>SindbadOptimization</code> package provides tools for optimizing SINDBAD models, including parameter estimation, model calibration, and cost function evaluation. It integrates various optimization algorithms and utilities to streamline the optimization workflow for SINDBAD experiments.</p><p><strong>Purpose:</strong></p><p>This package is designed to support optimization tasks in SINDBAD, such as calibrating model parameters to match observations or minimizing cost functions. It leverages multiple optimization libraries and provides a unified interface for running optimization routines.</p><p><strong>Dependencies:</strong></p><ul><li><p><code>CMAEvolutionStrategy</code>: Provides the CMA-ES (Covariance Matrix Adaptation Evolution Strategy) algorithm for global optimization.</p></li><li><p><code>Evolutionary</code>: Supplies evolutionary algorithms for optimization, useful for non-convex problems.</p></li><li><p><code>ForwardDiff</code>: Enables automatic differentiation for gradient-based optimization methods.</p></li><li><p><code>InteractiveUtils</code>: Facilitates interactive exploration and debugging during optimization.</p></li><li><p><code>MultistartOptimization</code>: Implements multistart optimization for finding global optima by running multiple local optimizations.</p></li><li><p><code>NLopt</code>: Provides a collection of nonlinear optimization algorithms, including derivative-free methods.</p></li><li><p><code>Optim</code>: Supplies optimization algorithms such as BFGS and LBFGS for gradient-based optimization.</p></li><li><p><code>Optimization</code>: A unified interface for various optimization backends, simplifying the integration of multiple libraries.</p></li><li><p><code>OptimizationOptimJL</code>: Integrates the <code>Optim</code> library into the <code>Optimization</code> interface.</p></li><li><p><code>OptimizationBBO</code>: Provides black-box optimization methods for derivative-free optimization.</p></li><li><p><code>OptimizationGCMAES</code>: Implements the GCMA-ES (Global Covariance Matrix Adaptation Evolution Strategy) algorithm.</p></li><li><p><code>OptimizationCMAEvolutionStrategy</code>: Integrates CMA-ES into the <code>Optimization</code> interface.</p></li><li><p><code>SindbadTEM</code>: Provides the SINDBAD Terrestrial Ecosystem Model (TEM) as the target for optimization tasks.</p></li><li><p><code>SindbadMetrics</code>: Supplies metrics for evaluating model performance, which are used in cost function calculations.</p></li></ul><p><strong>Included Files:</strong></p><ol><li><strong><code>prepOpti.jl</code></strong>:</li></ol><ul><li>Prepares the necessary inputs and configurations for running optimization routines.</li></ul><ol start="2"><li><strong><code>optimizer.jl</code></strong>:</li></ol><ul><li>Implements the core optimization logic, including merging algorithm options and selecting optimization methods.</li></ul><ol start="3"><li><strong><code>cost.jl</code></strong>:</li></ol><ul><li>Defines cost functions for evaluating the loss of SINDBAD models against observations.</li></ul><ol start="4"><li><strong><code>optimizeTEM.jl</code></strong>:</li></ol><ul><li><p>Provides functions for optimizing SINDBAD TEM parameters for single locations or small spatial grids.</p></li><li><p>Functionality to handle optimization using large-scale 3D data YAXArrays cubes, enabling parameter calibration across spatial dimensions.</p></li></ul><div class="tip custom-block"><p class="custom-block-title">Note</p><ul><li><p>The package integrates multiple optimization libraries, allowing users to choose the most suitable algorithm for their problem.</p></li><li><p>Designed to be modular and extensible, enabling users to customize optimization workflows for specific use cases.</p></li><li><p>Supports both gradient-based and derivative-free optimization methods, ensuring flexibility for different types of cost functions.</p></li></ul></div><p><strong>Examples:</strong></p><ol><li><strong>Running a CMA-ES optimization</strong>:</li></ol><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">using</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SindbadOptimization</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">optimized_params </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> optimizer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cost_function, default_values, lower_bounds, upper_bounds, algo_options, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CMAEvolutionStrategyCMAES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span></code></pre></div><ol><li><strong>Optimizing SINDBAD TEM parameters</strong>:</li></ol><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">using</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SindbadOptimization</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">results </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> optimizeTEM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(model, forcing, observations, info)</span></span></code></pre></div>`,21))]),i[39]||(i[39]=t("h2",{id:"exported",tabindex:"-1"},[e("Exported "),t("a",{class:"header-anchor",href:"#exported","aria-label":'Permalink to "Exported"'},"​")],-1)),t("details",h,[t("summary",null,[i[3]||(i[3]=t("a",{id:"SindbadOptimization.cost",href:"#SindbadOptimization.cost"},[t("span",{class:"jlbinding"},"SindbadOptimization.cost")],-1)),i[4]||(i[4]=e()),a(s,{type:"info",class:"jlObjectType jlFunction",text:"Function"})]),i[5]||(i[5]=o('<div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cost</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(param_vector, default_values, selected_models, space_forcing, space_spinup_forcing, loc_forcing_t, output_array, space_output, space_land, tem_info, observations, param_updater, cost_options, multi_constraint_method, parameter_scaling_type, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SindbadCostMethod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>Calculate the cost for a parameter vector.</p><p><strong>Arguments</strong></p><ul><li><p><code>param_vector</code>: Vector of parameter values to be optimized</p></li><li><p>&#39;default_values&#39;: Default values for model parameters</p></li><li><p><code>selected_models</code>: Collection of selected models for simulation</p></li><li><p><code>space_forcing</code>: Forcing data for the main simulation period</p></li><li><p><code>space_spinup_forcing</code>: Forcing data for the spin-up period</p></li><li><p><code>loc_forcing_t</code>: Time-specific forcing data</p></li><li><p><code>output_array</code>: Array to store simulation outputs</p></li><li><p><code>space_output</code>: Spatial output configuration</p></li><li><p><code>space_land</code>: Land surface characteristics</p></li><li><p><code>tem_info</code>: Temporal information for simulation</p></li><li><p><code>observations</code>: Observed data for comparison</p></li><li><p><code>param_updater</code>: Function to update parameters</p></li><li><p><code>cost_options</code>: Options for cost function calculation</p></li><li><p><code>multi_constraint_method</code>: Method for handling multiple constraints</p></li><li><p><code>parameter_scaling_type</code>: Type of parameter scaling</p></li><li><p><code>&lt;:SindbadCostMethod</code>: a type parameter indicating cost calculation method</p><ul><li><p><code>::CostModelObs</code>: Type parameter indicating cost calculation between model and observations</p></li><li><p><code>::CostModelObsMT</code>: Type parameter indicating multi-threaded cost calculation from CostModelObs</p></li><li><p><code>::CostModelObsPriors</code>: Type parameter indicating cost calculation between model, observations, and priors. <code>NOTE THAT THIS METHOD IS JUST A PLACEHOLDER AND DOES NOT CALCULATE PRIOR COST PROPERLY YET</code>.</p></li></ul></li></ul><p><strong>Returns</strong></p><p>Cost value representing the difference between model outputs and observations</p><p><strong>Description</strong></p><p>Computes the cost function by comparing model simulation results with observational data, considering various spatial and temporal configurations, parameter scaling, and multiple constraint methods.</p>',8))]),t("details",u,[t("summary",null,[i[6]||(i[6]=t("a",{id:"SindbadOptimization.costLand",href:"#SindbadOptimization.costLand"},[t("span",{class:"jlbinding"},"SindbadOptimization.costLand")],-1)),i[7]||(i[7]=e()),a(s,{type:"info",class:"jlObjectType jlFunction",text:"Function"})]),i[8]||(i[8]=o(`<div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">costLand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(param_vector</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">AbstractArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, selected_models, forcing, spinup_forcing, loc_forcing_t, land_timeseries, land_init, tem_info, observations, param_updater, cost_options, multi_constraint_method, parameter_scaling_type)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">costLand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(param_vector</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">AbstractArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, selected_models, forcing, spinup_forcing, loc_forcing_t, _, land_init, tem_info, observations, param_updater, cost_options, multi_constraint_method, parameter_scaling_type)</span></span></code></pre></div><p>Calculates the cost of SINDBAD model simulations for a single location by comparing model outputs as collections of SINDBAD <code>land</code> with observations using specified metrics and constraints.</p><p>In the first variant, the <code>land_time_series</code> is preallocated for computational efficiency. In the second variant, the runTEM stacks the land using map function and the preallocations is not necessary.</p><p><strong>Arguments:</strong></p><ul><li><p><code>param_vector::AbstractArray</code>: A vector of model parameter values to be optimized.</p></li><li><p><code>selected_models</code>: A tuple of selected SINDBAD models in the given model structure, the parameters of which are optimized.</p></li><li><p><code>forcing</code>: A forcing NamedTuple containing the time series of environmental drivers for the simulation.</p></li><li><p><code>spinup_forcing</code>: A forcing NamedTuple for the spinup phase, used to initialize the model to a steady state.</p></li><li><p><code>loc_forcing_t</code>: A forcing NamedTuple for a single location and a single time step.</p></li><li><p><code>land_timeseries</code>: A preallocated vector to store the land state for each time step during the simulation.</p></li><li><p><code>land_init</code>: The initial SINDBAD land NamedTuple containing all fields and subfields.</p></li><li><p><code>tem_info</code>: A nested NamedTuple containing necessary information for running SINDBAD TEM, including helpers, models, and spinup configurations.</p></li><li><p><code>observations</code>: A NamedTuple or vector of arrays containing observational data, uncertainties, and masks for calculating performance metrics.</p></li><li><p><code>param_updater</code>: A function to update model parameters based on the <code>param_vector</code>.</p></li><li><p><code>cost_options</code>: A table specifying how each observation constraint should be used to calculate the cost or performance metric.</p></li><li><p><code>multi_constraint_method</code>: A method for combining the vector of costs into a single cost value or vector, as required by the optimization algorithm.</p></li><li><p><code>parameter_scaling_type</code>: Specifies the type of scaling applied to the parameters during optimization.</p></li></ul><p><strong>Returns:</strong></p><ul><li><code>cost_metric</code>: A scalar or vector representing the cost, calculated by comparing model outputs with observations using the specified metrics and constraints.</li></ul><div class="tip custom-block"><p class="custom-block-title">Note</p><ul><li><p>The function updates the selected models using the <code>param_vector</code> and <code>param_updater</code>.</p></li><li><p>It runs the SINDBAD TEM simulation for the specified location using <code>runTEM</code>.</p></li><li><p>The model outputs are compared with observations using <code>metricVector</code>, which calculates the performance metrics.</p></li><li><p>The resulting cost vector is combined into a single cost value or vector using <code>combineMetric</code> and the specified <code>multi_constraint_method</code>.</p></li></ul></div><p><strong>Examples:</strong></p><ol><li><strong>Calculating cost for a single location</strong>:</li></ol><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cost </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> costLand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(param_vector, selected_models, forcing, spinup_forcing, loc_forcing_t, land_timeseries, land_init, tem_info, observations, param_updater, cost_options, multi_constraint_method, parameter_scaling_type)</span></span></code></pre></div><ol><li><strong>Using a custom multi-constraint method</strong>:</li></ol><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">custom_method </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> CustomConstraintMethod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cost </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> costLand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(param_vector, selected_models, forcing, spinup_forcing, loc_forcing_t, land_timeseries, land_init, tem_info, observations, param_updater, cost_options, custom_method, parameter_scaling_type)</span></span></code></pre></div><ol><li><strong>Handling observational uncertainties</strong>:</li></ol><ul><li>Observations can include uncertainties and masks to refine the cost calculation, ensuring robust model evaluation.</li></ul>`,15))]),t("details",m,[t("summary",null,[i[9]||(i[9]=t("a",{id:"SindbadOptimization.getCostVectorSize",href:"#SindbadOptimization.getCostVectorSize"},[t("span",{class:"jlbinding"},"SindbadOptimization.getCostVectorSize")],-1)),i[10]||(i[10]=e()),a(s,{type:"info",class:"jlObjectType jlFunction",text:"Function"})]),i[11]||(i[11]=o('<div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">getCostVectorSize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(algo_options, param_vector, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SindbadOptimizationMethod</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SindbadGlobalSensitivityMethod)</span></span></code></pre></div><p>Calculates the size of the cost vector required for a specific optimization or sensitivity analysis method.</p><p><strong>Arguments:</strong></p><ul><li><p><code>algo_options</code>: A NamedTuple or dictionary containing algorithm-specific options (e.g., population size, number of trajectories).</p></li><li><p><code>param_vector</code>: A vector of parameters used in the optimization or sensitivity analysis.</p></li><li><p><code>::OptimizationMethod</code>: The optimization or sensitivity analysis method. Supported methods include:</p><ul><li><p><code>CMAEvolutionStrategyCMAES</code>: Covariance Matrix Adaptation Evolution Strategy.</p></li><li><p><code>GlobalSensitivityMorris</code>: Morris method for global sensitivity analysis.</p></li><li><p><code>GlobalSensitivitySobol</code>: Sobol method for global sensitivity analysis.</p></li><li><p><code>GlobalSensitivitySobolDM</code>: Sobol method with Design Matrices.</p></li></ul></li></ul><p><strong>Returns:</strong></p><ul><li>An integer representing the size of the cost vector required for the specified method.</li></ul><p><strong>Notes:</strong></p><ul><li><p>For <code>CMAEvolutionStrategyCMAES</code>, the size is determined by the population size or a default formula based on the parameter vector length.</p></li><li><p>For <code>GlobalSensitivityMorris</code>, the size is calculated as the product of the number of trajectories and the length of the design matrix.</p></li><li><p>For <code>GlobalSensitivitySobol</code>, the size is determined by the number of parameters and the number of samples.</p></li><li><p>For <code>GlobalSensitivitySobolDM</code>, the size is equivalent to that of <code>GlobalSensitivitySobol</code>.</p></li></ul>',8))]),t("details",g,[t("summary",null,[i[12]||(i[12]=t("a",{id:"SindbadOptimization.globalSensitivity",href:"#SindbadOptimization.globalSensitivity"},[t("span",{class:"jlbinding"},"SindbadOptimization.globalSensitivity")],-1)),i[13]||(i[13]=e()),a(s,{type:"info",class:"jlObjectType jlFunction",text:"Function"})]),i[14]||(i[14]=o('<div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">globalSensitivity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cost_function, method_options, p_bounds, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SindbadGlobalSensitivityMethod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; batch</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>Performs global sensitivity analysis using the specified method.</p><p><strong>Arguments:</strong></p><ul><li><p><code>cost_function</code>: A function that computes the cost or output of the model based on input parameters.</p></li><li><p><code>method_options</code>: A set of options specific to the chosen sensitivity analysis method.</p></li><li><p><code>p_bounds</code>: A vector or matrix specifying the bounds of the parameters for sensitivity analysis.</p></li><li><p><code>::SindbadGlobalSensitivityMethod</code>: The sensitivity analysis method to use. Supported methods include:</p><ul><li><p><code>GlobalSensitivityMorris</code>: Uses the Morris method for sensitivity analysis.</p></li><li><p><code>GlobalSensitivitySobol</code>: Uses the Sobol method for sensitivity analysis.</p></li><li><p><code>GlobalSensitivitySobolDM</code>: Uses the Sobol method with Design Matrices.</p></li></ul></li><li><p><code>batch</code>: A boolean flag indicating whether to perform batch processing (default: <code>true</code>).</p></li></ul><p><strong>Returns:</strong></p><ul><li>A <code>results</code> object containing the sensitivity indices and other relevant outputs for the specified method.</li></ul><p><strong>Notes:</strong></p><ul><li><p>The function internally calls the <code>gsa</code> function from the GlobalSensitivity.jl package with the specified method and options.</p></li><li><p>The <code>cost_function</code> should be defined to compute the model output based on the input parameters.</p></li><li><p>The <code>method_options</code> argument allows fine-tuning of the sensitivity analysis process for each method.</p></li></ul>',8))]),t("details",k,[t("summary",null,[i[15]||(i[15]=t("a",{id:"SindbadOptimization.optimizeTEM",href:"#SindbadOptimization.optimizeTEM"},[t("span",{class:"jlbinding"},"SindbadOptimization.optimizeTEM")],-1)),i[16]||(i[16]=e()),a(s,{type:"info",class:"jlObjectType jlFunction",text:"Function"})]),i[17]||(i[17]=o('<div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">optimizeTEM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(forcing</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NamedTuple</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, observations, info</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NamedTuple</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p><strong>Arguments:</strong></p><ul><li><p><code>forcing</code>: a forcing NT that contains the forcing time series set for ALL locations</p></li><li><p><code>observations</code>: a NT or a vector of arrays of observations, their uncertainties, and mask to use for calculation of performance metric/loss</p></li><li><p><code>info</code>: a SINDBAD NT that includes all information needed for setup and execution of an experiment</p></li></ul>',3))]),t("details",b,[t("summary",null,[i[18]||(i[18]=t("a",{id:"SindbadOptimization.optimizeTEMYax-NTuple{5, NamedTuple}",href:"#SindbadOptimization.optimizeTEMYax-NTuple{5, NamedTuple}"},[t("span",{class:"jlbinding"},"SindbadOptimization.optimizeTEMYax")],-1)),i[19]||(i[19]=e()),a(s,{type:"info",class:"jlObjectType jlMethod",text:"Method"})]),i[20]||(i[20]=o('<div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">optimizeTEMYax</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(forcing</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NamedTuple</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, output</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NamedTuple</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, tem</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NamedTuple</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, optim</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NamedTuple</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, observations</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NamedTuple</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; max_cache</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1e9</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>Optimizes the Terrestrial Ecosystem Model (TEM) parameters for each pixel by mapping over the YAXcube(s).</p><p><strong>Arguments</strong></p><ul><li><p><code>forcing::NamedTuple</code>: Input forcing data for the TEM model</p></li><li><p><code>output::NamedTuple</code>: Output configuration settings</p></li><li><p><code>tem::NamedTuple</code>: TEM model parameters and settings</p></li><li><p><code>optim::NamedTuple</code>: Optimization parameters and settings</p></li><li><p><code>observations::NamedTuple</code>: Observed data for model calibration</p></li></ul><p><strong>Keywords</strong></p><ul><li><code>max_cache::Float64=1e9</code>: Maximum cache size for optimization process</li></ul><p><strong>Returns</strong></p><p>Optimized TEM parameters cube</p>',8))]),t("details",f,[t("summary",null,[i[21]||(i[21]=t("a",{id:"SindbadOptimization.optimizer",href:"#SindbadOptimization.optimizer"},[t("span",{class:"jlbinding"},"SindbadOptimization.optimizer")],-1)),i[22]||(i[22]=e()),a(s,{type:"info",class:"jlObjectType jlFunction",text:"Function"})]),i[23]||(i[23]=o('<div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">optimizer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cost_function, default_values, lower_bounds, upper_bounds, algo_options, algorithm </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SindbadOptimizationMethod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>Optimize model parameters using various optimization algorithms.</p><p><strong>Arguments:</strong></p><ul><li><p><code>cost_function</code>: A function handle that takes a parameter vector as input and calculates a cost/loss (scalar or vector).</p></li><li><p><code>default_values</code>: A vector of default parameter values to initialize the optimization.</p></li><li><p><code>lower_bounds</code>: A vector of lower bounds for the parameters.</p></li><li><p><code>upper_bounds</code>: A vector of upper bounds for the parameters.</p></li><li><p><code>algo_options</code>: A set of options specific to the chosen optimization algorithm.</p></li><li><p><code>algorithm &lt;:SindbadOptimizationMethod</code>: The optimization algorithm to be used. Supported algorithms include:</p><ul><li><p><code>BayesOptKMaternARD5</code>: Uses the kMaternARD5 method from the BayesOpt.jl package.</p></li><li><p><code>CMAEvolutionStrategyCMAES</code>: Uses the CMAES method from the CMAEvolutionStrategy.jl package.</p></li><li><p><code>EvolutionaryCMAES</code>: Uses the CMAES method from the Evolutionary.jl package.</p></li><li><p><code>OptimLBFGS</code>: Uses the LBFGS method from the Optim.jl package.</p></li><li><p><code>OptimBFGS</code>: Uses the BFGS method from the Optim.jl package.</p></li><li><p><code>OptimizationBBOxnes</code>: Uses the Black Box Optimization (xNES) method from the Optimization.jl package.</p></li><li><p><code>OptimizationBBOadaptive</code>: Uses the Black Box Optimization (adaptive) method from the Optimization.jl package.</p></li><li><p><code>OptimizationBFGS</code>: Uses the BFGS method from the Optimization.jl package.</p></li><li><p><code>OptimizationFminboxGradientDescent</code>: Uses the Fminbox Gradient Descent method from the Optimization.jl package.</p></li><li><p><code>OptimizationFminboxGradientDescentFD</code>: Uses the Fminbox Gradient Descent method with forward differentiation from the Optimization.jl package.</p></li><li><p><code>OptimizationGCMAESDef</code>: Uses the GCMAES method from the Optimization.jl package.</p></li><li><p><code>OptimizationGCMAESFD</code>: Uses the GCMAES method with forward differentiation from the Optimization.jl package.</p></li><li><p><code>OptimizationMultistartOptimization</code>: Uses the Multistart Optimization method from the Optimization.jl package.</p></li><li><p><code>OptimizationNelderMead</code>: Uses the Nelder-Mead method from the Optimization.jl package.</p></li><li><p><code>OptimizationQuadDirect</code>: Uses the QuadDIRECT method from the Optimization.jl package.</p></li></ul></li></ul><p><strong>Returns:</strong></p><ul><li><code>optim_para</code>: A vector of optimized parameter values.</li></ul><p><strong>Extended help</strong></p><p><strong>Notes:</strong></p><ul><li><p>The function supports a wide range of optimization algorithms, each tailored for specific use cases.</p></li><li><p>Some methods do not require bounds for optimization, while others do.</p></li><li><p>The <code>cost_function</code> should be defined by the user to calculate the loss based on the model output and observations. It is defined in cost.jl.</p></li><li><p>The <code>algo_options</code> argument allows fine-tuning of the optimization process for each algorithm.</p></li><li><p>Some algorithms (e.g., <code>BayesOptKMaternARD5</code>, <code>OptimizationBBOxnes</code>) require additional configuration steps, such as setting kernels or merging default and user-defined options.</p></li></ul><p><strong>Examples:</strong></p><ol><li><strong>Using CMAES from CMAEvolutionStrategy.jl</strong>:</li></ol><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">optim_para </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> optimizer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cost_function, default_values, lower_bounds, upper_bounds, algo_options, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CMAEvolutionStrategyCMAES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span></code></pre></div><ol><li><strong>Using BFGS from Optim.jl</strong>:</li></ol><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">optim_para </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> optimizer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cost_function, default_values, lower_bounds, upper_bounds, algo_options, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">OptimBFGS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span></code></pre></div><ol><li><strong>Using Black Box Optimization (xNES) from Optimization.jl</strong>:</li></ol><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">optim_para </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> optimizer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cost_function, default_values, lower_bounds, upper_bounds, algo_options, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">OptimizationBBOxnes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span></code></pre></div><p><strong>Implementation Details:</strong></p><ul><li><p>The function internally calls the appropriate optimization library and algorithm based on the <code>algorithm</code> argument.</p></li><li><p>Each algorithm has its own implementation details, such as handling bounds, configuring options, and solving the optimization problem.</p></li><li><p>The results are processed to extract the optimized parameter vector (<code>optim_para</code>), which is returned to the user.</p></li></ul>',18))]),t("details",y,[t("summary",null,[i[24]||(i[24]=t("a",{id:"SindbadOptimization.prepCostOptions",href:"#SindbadOptimization.prepCostOptions"},[t("span",{class:"jlbinding"},"SindbadOptimization.prepCostOptions")],-1)),i[25]||(i[25]=e()),a(s,{type:"info",class:"jlObjectType jlFunction",text:"Function"})]),i[26]||(i[26]=o('<div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">prepCostOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(observations, cost_options, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SindbadCostMethod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>Prepares cost options for optimization by filtering variables with insufficient data points and setting up the required configurations.</p><p><strong>Arguments:</strong></p><ul><li><p><code>observations</code>: A NamedTuple or a vector of arrays containing observation data, uncertainties, and masks used for calculating performance metrics or loss.</p></li><li><p><code>cost_options</code>: A table listing each observation constraint and its configuration for calculating the loss or performance metric.</p></li><li><p><code>::SindbadCostMethod</code>: A type indicating the cost function method. Supported methods include:</p><ul><li><p><code>CostModelObs</code>: Cost based on observation data.</p></li><li><p><code>CostModelObsPriors</code>: Cost based on observation data and priors.</p></li></ul></li></ul><p><strong>Returns:</strong></p><ul><li>A filtered table of <code>cost_options</code> containing only valid variables with sufficient data points.</li></ul><p><strong>Notes:</strong></p><ul><li><p>The function iterates through the observation variables and checks if the number of valid data points meets the minimum threshold specified in <code>cost_options.min_data_points</code>.</p></li><li><p>Variables with insufficient data points are excluded from the returned <code>cost_options</code>.</p></li><li><p>The function modifies the <code>cost_options</code> table by adding:</p><ul><li><p><code>valids</code>: Indices of valid data points for each variable.</p></li><li><p><code>is_valid</code>: A boolean flag indicating whether the variable meets the minimum data point requirement.</p></li></ul></li><li><p>Unnecessary fields such as <code>min_data_points</code>, <code>temporal_data_aggr</code>, and <code>aggr_func</code> are removed from the final <code>cost_options</code>.</p></li></ul>',8))]),t("details",_,[t("summary",null,[i[27]||(i[27]=t("a",{id:"SindbadOptimization.prepOpti",href:"#SindbadOptimization.prepOpti"},[t("span",{class:"jlbinding"},"SindbadOptimization.prepOpti")],-1)),i[28]||(i[28]=e()),a(s,{type:"info",class:"jlObjectType jlFunction",text:"Function"})]),i[29]||(i[29]=o('<div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">prepOpti</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(forcing, observations, info, optimization_cost_method</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CostModelObs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>Prepares optimization parameters, settings, and helper functions based on the provided inputs.</p><p><strong>Arguments:</strong></p><ul><li><p><code>forcing</code>: Input forcing data used for the optimization process.</p></li><li><p><code>observations</code>: Observed data used for comparison or calibration during optimization.</p></li><li><p><code>info</code>: A SINDBAD NamedTuple containing all information needed for setup and execution of the experiment.</p></li><li><p><code>optimization_cost_method</code>: The method used to calculate the cost function. Supported methods include:</p><ul><li><p><code>CostModelObs</code>: Cost based on observation data.</p></li><li><p><code>CostModelObsPriors</code>: Cost based on observation data and priors.</p></li><li><p><code>CostModelObsLandTS</code>: Cost based on land time series data.</p></li><li><p><code>CostModelObsMT</code>: Cost with multi-threaded computation.</p></li></ul></li></ul><p><strong>Returns:</strong></p><ul><li>A NamedTuple <code>opti_helpers</code> containing: <ul><li><p><code>tbl_params</code>: Processed model parameters for optimization.</p></li><li><p><code>cost_function</code>: A function to compute the cost for optimization.</p></li><li><p><code>cost_options</code>: Options and settings for the cost function.</p></li><li><p><code>default_values</code>: Default parameter values for the models.</p></li><li><p><code>lower_bounds</code>: Lower bounds for the parameters.</p></li><li><p><code>upper_bounds</code>: Upper bounds for the parameters.</p></li><li><p><code>run_helpers</code>: Helper information for running the optimization.</p></li></ul></li></ul><p><strong>Notes:</strong></p><ul><li><p>The function processes the input data and configuration to set up the optimization problem.</p></li><li><p>It prepares model parameters, cost options, and helper functions required for the optimization process.</p></li><li><p>Depending on the <code>optimization_cost_method</code>, the cost function is customized to handle specific data types or computation methods.</p></li></ul>',8))]),t("details",E,[t("summary",null,[i[30]||(i[30]=t("a",{id:"SindbadOptimization.prepParameters-NTuple{6, Any}",href:"#SindbadOptimization.prepParameters-NTuple{6, Any}"},[t("span",{class:"jlbinding"},"SindbadOptimization.prepParameters")],-1)),i[31]||(i[31]=e()),a(s,{type:"info",class:"jlObjectType jlMethod",text:"Method"})]),i[32]||(i[32]=o('<div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">prepParameters</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(selected_models, model_parameter_default, model_parameters_to_optimize, num_type, temporal_resolution, optimization_parameter_scaling)</span></span></code></pre></div><p>Prepare model parameters for optimization by processing default parameters and parameters to be optimized.</p><p><strong>Arguments</strong></p><ul><li><p><code>selected_models</code>: Collection of models selected for parameter optimization</p></li><li><p><code>model_parameter_default</code>: Default parameter values for the models</p></li><li><p><code>model_parameters_to_optimize</code>: Parameters that will be optimized</p></li><li><p><code>num_type</code>: Numerical type to be used (e.g., Float64)</p></li><li><p><code>temporal_resolution</code>: Time resolution for the model parameters</p></li><li><p><code>optimization_parameter_scaling</code>: Scaling method/type for parameter optimization</p></li></ul><p><strong>Returns</strong></p><p>A tuple containing processed parameters ready for optimization</p>',6))]),i[40]||(i[40]=t("h2",{id:"internal",tabindex:"-1"},[e("Internal "),t("a",{class:"header-anchor",href:"#internal","aria-label":'Permalink to "Internal"'},"​")],-1)),t("details",v,[t("summary",null,[i[33]||(i[33]=t("a",{id:"SindbadOptimization.optimizeYax-Tuple",href:"#SindbadOptimization.optimizeYax-Tuple"},[t("span",{class:"jlbinding"},"SindbadOptimization.optimizeYax")],-1)),i[34]||(i[34]=e()),a(s,{type:"info",class:"jlObjectType jlMethod",text:"Method"})]),i[35]||(i[35]=o('<div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">optimizeYax</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(map_cubes</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; out</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NamedTuple</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, tem</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NamedTuple</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, optim</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NamedTuple</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, forcing_vars</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">AbstractArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, obs_vars</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">AbstractArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>A helper function to optimize parameters for each pixel by mapping over the YAXcube(s).</p><p><strong>Arguments</strong></p><ul><li><p><code>map_cubes...</code>: Variadic input of cube maps to be optimized</p></li><li><p><code>out::NamedTuple</code>: Output configuration parameters</p></li><li><p><code>tem::NamedTuple</code>: TEM (Terrestrial Ecosystem Model) configuration parameters</p></li><li><p><code>optim::NamedTuple</code>: Optimization configuration parameters</p></li><li><p><code>forcing_vars::AbstractArray</code>: Array of forcing variables used in optimization</p></li><li><p><code>obs_vars::AbstractArray</code>: Array of observation variables used in optimization</p></li></ul>',4))]),t("details",C,[t("summary",null,[i[36]||(i[36]=t("a",{id:"SindbadOptimization.unpackYaxOpti-Tuple{Any}",href:"#SindbadOptimization.unpackYaxOpti-Tuple{Any}"},[t("span",{class:"jlbinding"},"SindbadOptimization.unpackYaxOpti")],-1)),i[37]||(i[37]=e()),a(s,{type:"info",class:"jlObjectType jlMethod",text:"Method"})]),i[38]||(i[38]=o('<div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">unpackYaxOpti</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(args; forcing_vars</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">AbstractArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>Unpacks the variables for the mapCube function</p><p><strong>Arguments</strong></p><ul><li><p><code>all_cubes</code>: Collection of cubes containing input, output and optimization/observation variables</p></li><li><p><code>forcing_vars::AbstractArray</code>: Array specifying which variables should be forced/constrained</p></li></ul><p><strong>Returns</strong></p><p>Unpacked data arrays</p>',6))])])}const D=n(r,[["render",z]]);export{M as __pageData,D as default};
