try
    gone
catch
end

%% setup paths
for fn = {'tools','model','optimization'}
    addpath(genpath(['../../' fn{1}]),'-begin')
end

outpath='/Net/Groups/BGI/work_3/sindbad/data/testBeds/output';
%% provide an experiment configuration file
expConfigFile               =   'testBeds/runwCycle/settings_runwCycle/experiment_wCycle.json';

%% run the experiment
% generated code and reduced memory array
[f_rm,fe_rm,fx_rm,s_rm,d_rm,p_rm,precOnceData_rm,fSU_rm,feSU_rm,fxSU_rm,sSU_rm,dSU_rm,precOnceDataSU_rm,info_rm,obs_rm,cost_rm] = ...
    workflowExperiment(expConfigFile,'info.tem.model.flags.genRedMemCode',true,...
                                     'info.tem.model.flags.runGenCode',true...
    info.experiment.outputDirPath...
    ;

% handles
[f_h,fe_h,fx_h,s_h,d_h,p_h,precOnceData_h,fSU_h,feSU_h,fxSU_h,sSU_h,dSU_h,precOnceDataSU_h,info_h,obs_h,cost_h] = ...
    workflowExperiment(expConfigFile,'info.tem.model.flags.runGenCode',false);

% generated code
[f_gc,fe_gc,fx_gc,s_gc,d_gc,p_gc,precOnceData_gc,fSU_gc,feSU_gc,fxSU_gc,sSU_gc,dSU_gc,precOnceDataSU_gc,info_gc,obs_gc,cost_gc] = ...
    workflowExperiment(expConfigFile,'info.tem.model.flags.runGenCode',true);


%% FIGURES

fNamesf=fields(f_h);
fNamesfx=fields(fx_h);
fNamesd=fields(d_h.storedStates);

% handles vs generated code
for fn = 1:numel(fNamesf)
    figure
    mk121s(nanmean(f_h.(fNamesf{fn}),1),nanmean(f_gc.(fNamesf{fn}),1),['handle'],['generated'],'LineWidth',2,'marker','o')
    title(['forcing: ' fNamesf{fn}])
end
for fn = 1:numel(fNamesfx)
    figure
    mk121s(nanmean(fx_h.(fNamesfx{fn}),1),nanmean(fx_gc.(fNamesfx{fn}),1),['handle'],['generated'],'LineWidth',2,'marker','o')
    title(['flux: ' fNamesfx{fn}])
end
for fn = 1:numel(fNamesd)
    figure
    mk121s(nanmean(d_h.storedStates.(fNamesd{fn}),1),nanmean(d_gc.storedStates.(fNamesd{fn}),1),['handle'],['generated'],'LineWidth',2,'marker','o')
    title(['diagnostic stored states: ' fNamesd{fn}])
end

% reduced array vs full array generated code
for fn = 1:numel(fNamesfx)
    figure
    mk121s(fx_gc.(fNamesfx{fn})(:,end),fx_rm.(fNamesfx{fn})(:,1),['generated'],['reduced memory'],'LineWidth',2,'marker','o')
    %     scatter(mean(fx_h.(fNamesfx{fn}),1),mean(fx_gc.(fNamesfx{fn}),1))
    title(['flux: ' fNamesfx{fn}])
end
for fn = 1:numel(fNamesd)
    figure
    mk121s(d_gc.storedStates.(fNamesd{fn})(:,end),d_rm.storedStates.(fNamesd{fn})(:,1),['handle'],['reduced memory'],'LineWidth',2,'marker','o')
    title(['diagnostic stored states: ' fNamesd{fn}])
end



% reduced array vs full array handle code
for fn = 1:numel(fNamesfx)
    figure
    mk121s(fx_h.(fNamesfx{fn})(:,end),fx_rm.(fNamesfx{fn})(:,end),['handle'],['reduced memory'],'LineWidth',2,'marker','o')
    %     scatter(mean(fx_h.(fNamesfx{fn}),1),mean(fx_gc.(fNamesfx{fn}),1))
    title(['flux: ' fNamesfx{fn}])
end
for fn = 1:numel(fNamesd)
    figure
    mk121s(d_h.storedStates.(fNamesd{fn})(:,end),d_rm.storedStates.(fNamesd{fn})(:,end),['handle'],['reduced memory'],'LineWidth',2,'marker','o')
    title(['diagnostic stored states: ' fNamesd{fn}])
end

